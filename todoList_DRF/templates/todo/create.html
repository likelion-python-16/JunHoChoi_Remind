{% extends "base.html" %}

{% load static %}

{% block content %}

<div class="container" id="todoCreatePage">
	<h2>Create a New Todo</h2>
		<div>
			<label for="name">Name:</label>
			<input type="text" name="name" id="name">
		</div>
		<div>
			<label for="description">Description:</label>
			<textarea name="description" id="description"></textarea>
		</div>
		<div>
			<label for="complete">Complete:</label>
			<input type="checkbox" name="complete" id="complete">
		</div>
    <div style="display: none;">
			<label for="completed_at">Completed At:</label>
      <input type="datetime-local" name="completed_at" id="completed_at">
		</div>
    <div>
      <label for="image">Images:</label>
      <input type="file" name="image" id="image">
	  </div>
		<div>
			<label for="exp">Experience Points:</label>
			<input type="number" name="exp" id="exp" min="0">
		</div>
		<button type="submit" id="todoCreate">Create</button>
</div>



<script>
// 1. Î¨∏ÏÑúÍ∞Ä ÏôÑÏ†ÑÌûà Î°úÎìúÎêòÎ©¥ Ï¥àÍ∏∞Ìôî Ïã§Ìñâ 
document.addEventListener('DOMContentLoaded', init);

// 2. UI Ïù¥Î≤§Ìä∏
function init() {
  bindUIEvents(); // Î≤ÑÌäºÏóê ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
}

// 3. UI Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
// ÌÅ¥Î¶≠, Ïä§ÌÅ¨Î°§, ÌÉ≠ÌÇ§ ... Î¨∏ÏÑúÎ°úÎî©...
function bindUIEvents() {
  const btn = document.getElementById('todoCreate');
  if (!btn) return;
  btn.addEventListener('click', onCreateClick); // ÌÅ¥Î¶≠ Ïãú 4Î≤à Ïã§Ìñâ
}

// Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Î∞è Ï†ÑÏÜ°
function onCreateClick() {
  //Îç∞Ïù¥ÌÑ∞Î•º ÌèºÏúºÎ°ú Î∂ÄÌÑ∞ ÏàòÏßë
  const payload = gatherFormData(); 
  console.log(" payload  :", payload);
  //ÏÑúÎ≤ÑÏóê Ï†ÑÏÜ°
  createTodo(payload); 
}

//  6. API Ìò∏Ï∂ú: Todo ÏÉùÏÑ± ÏöîÏ≤≠
function createTodo(data) {
  axiosInstance
    .post(`${TODO_API_CREATE_URL}`, data)
    .then(onCreateSuccess) // 7Î≤à: ÏÑ±Í≥µ Ïãú Ï≤òÎ¶¨
    .catch(onCreateError); // 8Î≤à: Ïã§Ìå® Ïãú Ï≤òÎ¶¨
}

//  7. ÏÉùÏÑ± ÏÑ±Í≥µ Ìï∏Îì§Îü¨: Î™©Î°ù ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô 
function onCreateSuccess(response) {
  // ÏÉùÏÑ± ÌõÑ Î™©Î°ù ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
  window.location.href = '/todo/list/';
}


// --- 8. ÏÉùÏÑ± Ïã§Ìå® Ìï∏Îì§Îü¨: ÏóêÎü¨ ÏïåÎ¶º --------------------------------------
function onCreateError(error) {
  console.log("üî• Ïò§Î•ò ÏÉÅÏÑ∏:", error.response?.data || error);
  console.error('Todo ÏÉùÏÑ± Ïã§Ìå®:', error);
  alert('Todo ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
}


function gatherFormData() {
   //Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨
  const formData =new FormData();

  //Ïà´ÏûêÏ≤òÎ¶¨
  // let expVal = document.getElementById('exp').value;
  // if (expVal === '') expVal = 0; 
  const expInput = document.getElementById('exp');
  const expVal = expInput && expInput.value.trim() !=="" ? Number(expInput.value) : 0 ;

  

  //ÎÇ†ÏßúÏ≤òÎ¶¨
  //  const completedAtInput = document.getElementById('completed_at').value;
  //  const completedAt = datetimeToString(completedAtInput);


   //ÌÖçÏä§Ìä∏ ÌïÑÎìú Ï∂îÍ∞Ä
   formData.append("name", document.getElementById('name').value);
   formData.append("description", document.getElementById('description').value);
   formData.append("complete", document.getElementById('complete').checked);
   //formData.append("completed_at", completedAt);
   formData.append("exp", Number(expVal));
   
   //Ïù¥ÎØ∏ÏßÄ ÌååÏùº Ï∂îÍ∞Ä
   const imageInput =document.getElementById('image');
   if(imageInput && imageInput.files.length > 0){  //Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù¥ ÎßûÎäîÏßÄ Ïù¥ÎØ∏ÏßÄ ÌååÏùº Í∞ØÏàò > 0 ÌÅ¥Îïå
     formData.append('image', imageInput.files[0]); 
   }

   return formData;
}
</script>



<!--
// 5. Ìèº Îç∞Ïù¥ÌÑ∞ ÏàòÏßë: ÏûÖÎ†•Í∞íÏùÑ Í∞ùÏ≤¥Î°ú Î≥ÄÌôò 
{% comment %}
function gatherFormData() {
  //Îç∞Ïù¥ÌÑ∞ ÌèâÌÉÑÌôî
  let expVal = document.getElementById('exp').value;
  if (expVal === '') expVal = 0; 
  //ÌååÏù¥Ïç¨ input("0")
  // "0" ==0 true  ===false
  //ÏòàÏÉÅÏπò Î™ªÌïú ÏûêÎèô Î≥ÄÌôò ÎïåÎ¨∏Ïóê Î≤ÑÍ∑∏Í∞Ä Î∞úÏÉùÌï† Í∞ÄÎä•ÏùÑ ÎåÄÎπÑÌïòÏó¨  === ÏûëÏÑ±Ìï©ÎãàÎã§...
  const completedAtInput = document.getElementById('completed_at').value;
  // completedAtInput Í∞íÏù¥ ÏûàÏúºÎ©¥ -> Date Í∞ùÏ≤¥Î°ú Î≥ÄÌôòÌï¥ÏÑú ISO ÌòïÏãù Î¨∏ÏûêÏó¥Î°ú ÎßåÎì§Í≥† ÏóÜÏúºÎ©¥ null ÏÑ§Ï†ïÌï¥Îùº
  // ÏûêÎ∞îÏä§ÌÅ¨Î¶ΩÌä∏ ÏÇºÌï≠Ïó∞ÏÇ∞Ïûê

  const completedAt = completedAtInput ? new Date(completedAtInput).toISOString() : null;
  return {
    name:document.getElementById('name').value, // Ïù¥ Í∞ùÏ≤¥ ÏïàÏóê nameÏù¥ÎùºÎäî ÌÇ§(key) Î•º ÎßåÎì§Í≥†,Í∑∏ Í∞í(value)ÏùÄ document.getElementById('name').valueÎ°ú ÏÑ§Ï†ïÌï¥Îùº."
    description:document.getElementById('description').value,
    complete:document.getElementById('complete').checked,
    completed_at: completedAt,
    exp:Number(expVal),
  };
}{% endcomment %}
-->




{% endblock %}    