{% extends 'base.html' %}
{% load static %}

{% block content %}

{% if user.is_authenticated %}
    {# --- ê²€ìƒ‰ë°” ì¶”ê°€ --- #}
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
        <button id="searchBtn" class="btn">ê²€ìƒ‰</button>
    </div>  
    {# --- ê²€ìƒ‰ë°”ë --- #}

    <div class="todocontainer"></div>
    <div class="pagination"></div>
    <div class="todoCreateDiv">
        <button class="todoCreate" id="createBtn">Todo ë“±ë¡í•˜ê¸°</button>
    </div>
{% else %}
    <p>í•  ì¼ ëª©ë¡ì€ ë¡œê·¸ì¸ í›„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
{% endif %}






<script>
let currentPage = 1;    
let currentSearch="";

// 1. ë¬¸ì„œê°€ ì™„ì „íˆ ë¡œë“œë˜ë©´ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', init);

// 2. ì´ˆê¸°í™”: UI ì´ë²¤íŠ¸ ì—°ê²° ë° ì²« í˜ì´ì§€ Todo ëª©ë¡ ë¡œë“œ
function init() {
    UIEvents(); // 2-1. ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
    loadTodoList(1); // 2-2. ì²« í˜ì´ì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
}

// 2-1. UI ì´ë²¤íŠ¸ ë°”ì¸ë”©: "Todo ë“±ë¡í•˜ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™
function UIEvents() {
    document.getElementById('createBtn').addEventListener('click', onCreateClick);

    // ê²€ìƒ‰ ë²„íŠ¼ ì´ë² íŠ¼ ë°”ì¸ë”©
    document.getElementById("searchBtn").addEventListener("click", onSearchClick);

}

function onSearchClick() {
   currentSearch=document.getElementById("searchInput").value.trim();
   loadTodoList(1);
}



// 2-1-1. ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì‹œ /todo/create/ë¡œ ì´ë™
function onCreateClick() {
    window.location.href = '/todo/create/';
}


function fetchTodoData(currentPage, currentSearch=""){    
    console.log(" fetchTodoData currentPage : ", currentPage, " currentSearch : ", currentSearch);

    // í˜ì´ì§€ë„¤ì´ì…˜ ë°ì´í„° ìš”ì²­
    return  axiosInstance.get(`${TODO_API_LIST_URL}`,{
        params: {
            page:currentPage,
            search:currentSearch
        }
    })
    .then(res => {
            res.data
            console.log("ì‘ë‹µë°ì´í„° : ", res.data);
            return res.data;
        }
    );
}


// 5. íŠ¹ì • í˜ì´ì§€ì˜ Todo ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ë Œë”ë§
function loadTodoList(page) {
    currentPage = page;
    fetchTodoData(currentPage, currentSearch)
        .then(data => {
            console.log("ì „ì²´ ì‘ë‹µ ë°ì´í„°", data);              
            console.log("ì´ ê°œìˆ˜:", data.count);  // ë””ë²„ê¹…ìš©

            const todos = extractTodoArray(data);  // ì‹¤ì œ Todo ë°°ì—´ ì¶”ì¶œ         
            renderTodoList(todos);                // ëª©ë¡ ë Œë”ë§
            //í˜ì´ì§€ë„¤ì´ì…˜ ì¶”ê°€
            renderPagination(data, currentPage);
        })
        .catch(err => console.log("ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨", err));
}




// 3-2. API ì‘ë‹µ í˜•ì‹ì— ë”°ë¼ Todo ë°°ì—´ ì¶”ì¶œ
function extractTodoArray(data) {
    // 1) CustomPageNumberPagination ì‚¬ìš© ì‹œ
    if (Array.isArray(data.data)) {
        return data.data;
    }
    // 2) ê¸°ë³¸ PageNumberPagination ì‚¬ìš© ì‹œ
    if (Array.isArray(data.results)) {
        return data.results;
    }
    // 3) Pagination ì—†ì´ ìˆœìˆ˜ ë°°ì—´ ë¦¬í„´ ì‹œ
    if (Array.isArray(data)) {
        return data;
    }
    return [];
}



// 3-3. ì¶”ì¶œëœ Todo í•­ëª©ë“¤ì„ í™”ë©´ì— ë Œë”ë§
function renderTodoList(todos) {
    const container = document.querySelector('.todocontainer');
    container.innerHTML = '';
    todos.forEach(todo => container.appendChild(createTodoElement(todo)));


    addEventListenersForButtons();
} 


function addEventListenersForButtons() {
  document.querySelectorAll('.likeBtn').forEach(btn => {
    btn.removeEventListener('click', likeBtnHandler); // ê¸°ì¡´ ì œê±° (ì„ íƒì )
    btn.addEventListener('click', likeBtnHandler);
  });

  document.querySelectorAll('.bookmarkBtn').forEach(btn => {
    btn.removeEventListener('click', bookmarkBtnHandler);
    btn.addEventListener('click', bookmarkBtnHandler);
  });
}

function likeBtnHandler(e) {
  e.stopPropagation();
  toggleLike(e.currentTarget.dataset.id);
}

function bookmarkBtnHandler(e) {
  e.stopPropagation();
  toggleBookmark(e.currentTarget.dataset.bookmarkId);
}



// 3-3-1. ë‹¨ì¼ Todo ê°ì²´ë¥¼ HTML ìš”ì†Œë¡œ ìƒì„±

// ... ìƒëµëœ ê¸°ì¡´ ì½”ë“œ ìœ ì§€ ...

function createTodoElement(todo) {
    const div = document.createElement('div');
    div.className = 'todo-item';

    if (todo.complete) {
        div.classList.add('completed');
    }

    // âœ… HTML êµ¬ì¡°
    div.innerHTML = `
        <div class="todo-content" style="cursor:pointer;">
            <p><strong>Name:</strong> ${todo.name}</p>
            <p><strong>Description:</strong> ${todo.description}</p>
            <p><strong>Complete:</strong> ${todo.complete}</p>
            <p><strong>Completed At:</strong> ${datetimeToString(todo.completed_at)}</p>
            <p><strong>Image:</strong> 
                ${todo.image ? `<img src="${todo.image}" alt="${todo.name}" width="150">` : ''}
            </p>
            <p><strong>Experience Points:</strong> ${todo.exp}</p>
        </div>

        <div class="todo-actions" style="margin-top: 10px;">
         
            <button class="social-btn likeBtn"
            data-id="${todo.id}"><span class="icon">${todo.is_liked ? 'ğŸ’”' : 'â¤ï¸'}</span> 
            <span class="count">${todo.like_count}</span>
            </button>

            <button class="bookmarkBtn action-button" data-bookmark-id="${todo.id}">ğŸ”– ${todo.bookmark_count || todo.bookmark_count}</button>
            <button class="commentToggleBtn action-button" data-id="${todo.id}">ğŸ’¬ <span class="count">${todo.comments_count || 0}</span></button>
            <button class="detail-link action-button" data-id="${todo.id}">MYëŒ“ê¸€</button>
        </div>

        <div class="commentBox" style="display:none; padding: 10px;">
            <ul class="commentList"></ul>
            <div style="margin-top: 5px; display: flex; gap: 5px;">
              <input type="text" class="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex: 1; padding: 4px;">
              <button class="commentSubmit">ë“±ë¡</button>
            </div>
        </div>

        <button class="completeBtn">ì™„ë£Œ</button>
    `;

    div.querySelector('.todo-content').addEventListener('click', () => detailView(todo.id));

    div.querySelector('.completeBtn').addEventListener('click', e => {
        e.stopPropagation();
        toComplete(todo.id);
    });

    // ì¢‹ì•„ìš” ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡    
    div.querySelector('.likeBtn').addEventListener('click', e => {
        e.stopPropagation();
        toggleLike(todo.id); 
    });



    div.querySelector('.bookmarkBtn').addEventListener('click', e => {
        e.stopPropagation();
        toggleBookmark(todo.id); 
    });

    div.querySelector('.commentToggleBtn').addEventListener('click', e => {
        e.stopPropagation();
        const commentBox = div.querySelector('.commentBox');
        commentBox.style.display = (commentBox.style.display === 'none') ? 'block' : 'none';
        loadComments(todo.id, div.querySelector('.commentList'));
    });

     // ìƒˆì°½ ë§í¬ì˜ ì´ë²¤íŠ¸ ì „íŒŒ ì°¨ë‹¨    
    div.querySelector('.detail-link').addEventListener('click', e => {
        e.stopPropagation();
      
          // ìƒˆì°½ ì—´ê¸° (í¬ê¸°ì™€ ìœ„ì¹˜ ì§€ì •)
        window.open(
            `/interaction/todo/detail/${todo.id}/`, // ì—´ URL
            '_blank', // ìƒˆì°½
            'width=600,height=600,top=100,left=200,scrollbars=yes,resizable=yes' // ì˜µì…˜
            ); 
  
    });

    div.querySelector('.commentInput')?.addEventListener('click', e => e.stopPropagation());

    div.querySelector('.commentSubmit')?.addEventListener('click', e => {
        e.stopPropagation();
        const commentInput = div.querySelector('.commentInput');
        const content = commentInput.value;
        if (content.trim()) {
            postComment(todo.id, content, div.querySelector('.commentList'));
            commentInput.value = '';
        }
    });

    return div;
}



function postComment(todoId, content, listElement) {
  if (!content) return alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”");
  axiosInstance.post("/api/interaction/comments/", { todo_pk: todoId, content: content })
    .then(() => {
      loadComments(todoId, listElement);

      //ëŒ“ê¸€ ë“±ë¡ í›„ count ì¦ê°€
      const  todoElement = document.querySelector(`.todo-item`);
      const countSpan =todoElement?.querySelector('.commentToggleBtn .count');

      if (countSpan) {
        const currentCount = parseInt(countSpan.textContent || '0', 10);
        countSpan.textContent = currentCount + 1;
      }



    })
    .catch(error => {
      console.error("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:", error.response?.data || error);
      alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:\n" + JSON.stringify(error.response?.data, null, 2));
    });
}

function loadComments(todoId, listElement) {
  axiosInstance.get(`/api/interaction/comments/`, { params: { todo_pk: todoId } })
    .then(res => {
      const payload = Array.isArray(res.data) ? res.data : Array.isArray(res.data.results) ? res.data.results : (res.data.data || []);
      listElement.innerHTML = '';
      payload.forEach(c => {
        const li = document.createElement('li');
        li.innerHTML = `${c.user.username || c.username}: ${c.content} 
          <button class="comment-like-btn" data-id="${c.id}">ğŸ‘ ${c.like_count}</button>`;
        li.querySelector('.comment-like-btn')?.addEventListener('click', e => {
          e.stopPropagation();
          toggleCommentLike(c.id);
        });
        listElement.appendChild(li);
      });
    })
    .catch(err => console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:', err));
}

function toggleCommentLike(commentId) {
 axiosInstance.post(`/api/interaction/commentlikes/${commentId}/toggle/`)
    .then(res => {
      // ì¢‹ì•„ìš” ì²˜ë¦¬ ì„±ê³µ í›„ ì „ì²´ ëŒ“ê¸€ ë‹¤ì‹œ ë¡œë“œ
      const commentBtn = document.querySelector(`.comment-like-btn[data-id="${commentId}"]`);
      const todoElement = commentBtn.closest('.todo-item');
      const todoId = todoElement?.querySelector('.likeBtn')?.dataset?.id;
      const listElement = todoElement?.querySelector('.commentList');

      if (todoId && listElement) {
        loadComments(todoId, listElement);
      }
    })
    .catch(err => console.error("ëŒ“ê¸€ ì¢‹ì•„ìš” ì‹¤íŒ¨:", err));
}






// 3-3-2. ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ Todo í•­ëª©ì„ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
//ì£¼ì†Œ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ completeì„ trueë¡œ ë³€ê²½í•˜ê³ , loadTodoList í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•´ë¼.ì•„ë‹ˆë©´ ì™„ë£Œ ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ ì½˜ì†”ë¡œê·¸ì— ë„ì›Œë¼
function toComplete(id) { //ë§¤ê°œë³€ìˆ˜ ì´ë¦„ todo.id ê°’ì´ ì „ë‹¬ë¨
    axiosInstance.patch(`${TODO_API_UPDATE_URL}${id}/`, { complete: true })
        .then(() => loadTodoList(1))
        .catch(err => console.error('ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨:', err));
}

// 3-3-3. ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
function detailView(id) {
    window.location.href = `/todo/detail/${id}/`;
}



// 3-4. í˜ì´ì§€ë„¤ì´ì…˜ êµ¬ì„± (â† ì´ì „, 1 2 3, â†’ ë‹¤ìŒ)

function renderPagination(data, currentPage) {
    const wrapper = document.querySelector('.pagination');
    wrapper.innerHTML = '';

    console.log(" data.total_count  ",data.total_count);
    
    //const totalPages = Math.ceil(data.total_count / 5); // â† settings.pyì˜ PAGE_SIZE ê¸°ì¤€

    const  totalPages = data.page_count

    // ì´ì „ ë²„íŠ¼
    const prevBtn = document.createElement('button');
    prevBtn.innerText = 'â€¹';
    prevBtn.disabled = !data.previous;
    prevBtn.addEventListener('click', () => loadTodoList(currentPage - 1));
    wrapper.appendChild(prevBtn);

    // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        if (i === currentPage) {
            btn.disabled = true;
            btn.classList.add('active');
        }
        btn.addEventListener('click', () => loadTodoList(i));
        wrapper.appendChild(btn);
    }

    // ë‹¤ìŒ ë²„íŠ¼
    const nextBtn = document.createElement('button');
    nextBtn.innerText = 'â€º';
    nextBtn.disabled = !data.next;
    nextBtn.addEventListener('click', () => loadTodoList(currentPage + 1));
    wrapper.appendChild(nextBtn);
}



// ì¢‹ì•„ìš” í† ê¸€ í•¨ìˆ˜
function toggleLike(id) {
    axiosInstance.post(`/api/interaction/likes/${id}/toggle/`)
        .then(res => {
            const { is_liked, like_count } = res.data;
            const btn = document.querySelector(`.likeBtn[data-id="${id}"]`);
            if (btn) btn.innerHTML = `${is_liked ? 'ğŸ’”' : 'â¤ï¸'} <span class="count">${like_count}</span>`;
        })
        .catch(err => console.error(" ì¢‹ì•„ìš” í† ê¸€ ì‹¤íŒ¨:", err));
}




function toggleBookmark(id) {
    axiosInstance.post(`/api/interaction/bookmarks/${id}/toggle/`)
        .then(res => {
            const { is_bookmarked, bookmark_count } = res.data;
            console.log(`is_bookmarked: ${is_bookmarked}, bookmark_count: ${bookmark_count}`);
            const btn = document.querySelector(`.bookmarkBtn[data-bookmark-id="${id}"]`);
            if (btn) btn.innerHTML = `ğŸ”– <span class="count">${bookmark_count}</span>`;
        })
        .catch(err => console.error(' ë¶ë§ˆí¬ í† ê¸€ ì‹¤íŒ¨:', err));
}


// âœ… ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ ì¶”ê°€ (ë¹„ë™ê¸° ë Œë”ë§ ë¬¸ì œ í•´ê²°)
document.addEventListener('click', function(e) {
    const likeBtn = e.target.closest('.likeBtn');
    if (likeBtn) {
        e.stopPropagation();
        toggleLike(likeBtn.dataset.id);
        return;
    }

    const bookmarkBtn = e.target.closest('.bookmarkBtn');
    if (bookmarkBtn) {
        e.stopPropagation();
        toggleBookmark(bookmarkBtn.dataset.bookmarkId);
        return;
    }
});
</script>



{% endblock content %}
